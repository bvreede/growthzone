---
title: "Mitosis in the oncopeltus growthzone"
author: "Barbara Vreede"
date: "12/14/2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Based on our observations, mitosis in the germ band of *Oncopeltus* is not uniform. The anterior growth zone seems to have a reduced rate of cell division compared to the posterior growth zone and the rest of the germ band. These areas seem to correlate with distinct patterns of *even-skipped* (*eve*).

This can be quantitatively assessed by counting the number of cells in mitosis (as stained by PH3) over the total number of cells in that area (as stained by DAPI). Embryos are divided into three sections:

| Section | Description | Characterized by (*eve* pattern) |
|---------|-------------|----------------------------------|
| A | posterior growth zone | solid *eve* expression |
| B | anterior growth zone | striped *eve* expression |
| C | germ band | *eve* absent |

Count files were generated per embryo for each channel and each section separately, yielding 6 files in total per embryo.

First, load the data from the original files and construct a clean database in csv:
```{python extract data}
import os, re

rootdir = "/Users/BarbaraMaria/Dropbox/projects/2014_Ofas-measurements/postreview_cellcounts/"

#construct the database file
out = open("%s/cleandb.csv" %rootdir, "w")
out.write("embryoID,age,numerical_age,area,channel,cells\n")

#construct database 2
out2 = open("%s/cleandb_perembryo.csv" %rootdir, "w")
out2.write("embryoID,age,numerical_age,areaA_DAPI,areaA_PH3,areaB_DAPI,areaB_PH3,areaC_DAPI,areaC_PH3\n")

#make dictionaries for database 2 filling
agedict,numagedict,areaA_DAPI,areaA_PH3,areaB_DAPI,areaB_PH3,areaC_DAPI,areaC_PH3 = {},{},{},{},{},{},{},{}

#compile a regular expression to search for an age in the filename
agere = '[0-9]{2}-[0-9]{2}h'
agesearch = re.compile(agere)

#compile a regular expression to search for an area in the filename
areare = '_[ABC]{1}_'
areasearch = re.compile(areare)

for subdir,dirs,files in os.walk(rootdir):
	for f in files:
		#check if this is an xls result file
		if f.split('.')[-1] != 'xls':
			continue

		#what channel was used?
		if f.lower().find('dapi') >= 0:
			channel = 'DAPI'
		elif f.lower().find('gfp') >= 0:
			channel = 'PH3'
		else:
			channel = 'unknown'
		
		#what is the embryos age?
		age = agesearch.search(f).group()
		numage = int(age[0:2])+1 #extra column for numerical age
		
		#what is the area?
		area = areasearch.search(f).group()[1]
		
		#embryo ID
		eID = f.split(age)[0].lower()[:-1]
		
		#now open the file and retrieve the number of counts (i.e. number of cells)
		xlsfile = open("%s/%s" %(subdir,f))
		for line in xlsfile:
			ncells = line.split()[0] # first number in the line is the cell count; iterating through the file and updating ncells leaves the final ncells to be the last and highest number, ie. the total number of cells in the file
		xlsfile.close()
		
		#write output db
		out.write("%s,%s,%s,%s,%s,%s\n" %(eID,age,numage,area,channel,ncells))
		
		#fill the appropriate dictionaries
		agedict[eID] = age
		numagedict[eID] = numage
		if channel == "DAPI":
		  if area == "A":
		    areaA_DAPI[eID] = ncells
		  elif area == "B":
		    areaB_DAPI[eID] = ncells
		  elif area == "C":
		    areaC_DAPI[eID] = ncells
		elif channel == "PH3":
		  if area == "A":
		    areaA_PH3[eID] = ncells
		  elif area == "B":
		    areaB_PH3[eID] = ncells
		  elif area == "C":
		    areaC_PH3[eID] = ncells
		    
#write the second output db
for key in agedict:
  out2.write("%s," %key)
  out2.write("%s," %agedict[key])
  out2.write("%s," %numagedict[key])
  out2.write("%s," %areaA_DAPI[key])
  out2.write("%s," %areaA_PH3[key])
  out2.write("%s," %areaB_DAPI[key])
  out2.write("%s," %areaB_PH3[key])
  out2.write("%s," %areaC_DAPI[key])
  out2.write("%s\n " %areaC_PH3[key])
```

Next, load the database in R:
```{r load data}
ccdb <- read.csv("/Users/BarbaraMaria/Dropbox/projects/2014_Ofas-measurements/postreview_cellcounts/cleandb_perembryo.csv", header=T)
#remove the final row as it is empty!
ccdb <- ccdb[-dim(ccdb)[1],]

```
Print a table counting the number of embryos per age group.
```{r table}
embryotable <- table(ccdb$age)
embryotable
```

Explore the data. Let's first look at the absolute number of DAPI cells per age:
```{r dapi per age}
plot(areaA_DAPI ~ jitter(numerical_age, 0.5), data=ccdb, ylab="number of cells",xlab="age (hAEL)", main="Number of DAPI-stained cells", pch=1, col="darkblue",xlim=c(44,56),ylim=c(200,2400))
points(areaB_DAPI ~ jitter(numerical_age, 0.5), data=ccdb, pch=6, col="darkgreen")
points(areaC_DAPI ~ jitter(numerical_age, 0.5), data=ccdb, pch=3, col="darkred")

#make the legend
par(xpd=TRUE)
leg.txt <- c("posterior growthzone","anterior growthzone","germband")
leg.cols <- c("darkblue","darkgreen","darkred")
leg.pch <- c(1,6,3)
legend(42,-150, leg.txt,pch=leg.pch,col=leg.cols,bty="n")
```

This looks weird; as if the number of cells overall is low. What happens when we correct for the total number of cells?

```{r add total}
ccdb$totalcells <- ccdb$areaA_DAPI+ccdb$areaB_DAPI#+ccdb$areaC_DAPI #REMOVED BECAUSE GB SIZE VARIES
ccdb$areaA_DAPI_corrected <- ccdb$areaA_DAPI/ccdb$totalcells
ccdb$areaB_DAPI_corrected <- ccdb$areaB_DAPI/ccdb$totalcells
ccdb$areaC_DAPI_corrected <- ccdb$areaC_DAPI/ccdb$totalcells
```

Plot the calculated data:

```{r plot corrected dapi per age}
plot(totalcells ~ numerical_age, data=ccdb, ylab="number of cells",xlab="age (hAEL)",main="Total number of cells")

plot(areaA_DAPI_corrected ~ numerical_age, data=ccdb, ylab="proportion of cells in area",xlab="age (hAEL)",main="Posterior growth zone")
plot(areaB_DAPI_corrected ~ numerical_age, data=ccdb, ylab="proportion of cells in area",xlab="age (hAEL)",main="Anterior growth zone")
plot(areaC_DAPI_corrected ~ numerical_age, data=ccdb, ylab="proportion of cells in area",xlab="age (hAEL)",main="Germband")
```

Observations:
1. The overall data seems to be messy; particularly in the 48-50 age group the number of cells is lower than in others, but the range is huge in 44-46, 46-48 in particular. This needs more data to be conclusive (these embryos were all stained per age group, so there is no control for the experiment), so proceed with caution. The idea of this particular experiment is to get a feel for how the percentage of mitosing cells changes throughout development; this should still be possible, keeping in mind these results.
2. Correcting for the total number of cells is not the solution, it increases the messiness of the data.

So now, add columns with the fraction of PH3 cells over DAPI cells to the database.

```{r add columns}
ccdb$areaA <- ccdb$areaA_PH3/ccdb$areaA_DAPI
ccdb$areaB <- ccdb$areaB_PH3/ccdb$areaB_DAPI
ccdb$areaC <- ccdb$areaC_PH3/ccdb$areaC_DAPI
```

```{r plot fractions}
plot(areaA ~ numerical_age, data=ccdb, ylab="proportion of cells in mitosis",xlab="age (hAEL)",main="Posterior growth zone")
plot(areaB ~ numerical_age, data=ccdb, ylab="proportion of cells in mitosis",xlab="age (hAEL)",main="Anterior growth zone")
plot(areaC ~ numerical_age, data=ccdb, ylab="proportion of cells in mitosis",xlab="age (hAEL)",main="Germband")
```

Combine the plots in the same figure:

```{r combined plot}
#svg("/Users/BarbaraMaria/Dropbox/projects/2014_Ofas-measurements/mitosis_overtime.svg",width=10,height=7)
#make the plot
plot(areaA ~ jitter(numerical_age, 0.5), data=ccdb, ylab="proportion of cells in mitosis",xlab="age (hAEL)", main="Mitosis in the germ band", pch=1, col="darkblue",ylim=c(0,0.08),xlim=c(44,56))
points(areaB ~ jitter(numerical_age, 0.5), data=ccdb, pch=6, col="darkgreen")
points(areaC ~ jitter(numerical_age, 0.5), data=ccdb, pch=3, col="darkred")

#make the legend
par(xpd=TRUE)
leg.txt <- c("posterior growthzone","anterior growthzone","germband")
leg.cols <- c("darkblue","darkgreen","darkred")
leg.pch <- c(1,6,3)
legend(42,-0.013, leg.txt,pch=leg.pch,col=leg.cols,bty="n")
#dev.off()

```




## Statistics
Calculate for each time point independently if the anterior growth zone, the posterior growth zone, and the germ band data are significantly different from each other. Make the same calculation for the total dataset.

```{r anova}
#make table to fill with data
ratio.anova <- NULL

# one directional anova
anova.to.pval <- function(simpledb){
  fit <- lm(ratio ~ area+embID, data=simpledb)
  anova.temp <- anova(fit)
  pval <- anova.temp[5][1,] #extracts only the pvalue from the anova
  #direction <- coef(fit)[[2]] #extracts the direction of change from the linear model
  return(pval)
}

#collect all ages
ages_indb <- levels(ccdb$age)
#remove empty ages
ages_indb <- ages_indb[ages_indb != ""]

for(a in ages_indb){
  nembryos <- length(ccdb$age[ccdb$age == a])
  
  #collect data to put in mini-databases
  ratioA <- ccdb$areaA[ccdb$age == a]
  ratioB <- ccdb$areaB[ccdb$age == a]
  ratioC <- ccdb$areaC[ccdb$age == a]
  areaA <- rep("A",nembryos)
  areaB <- rep("B",nembryos)
  areaC <- rep("C",nembryos)
  
  # correct for embryo?
  embryoID <- 1:nembryos
  embID <- c(embryoID,embryoID)
  
  # A vs B
  ratio <- c(ratioA,ratioB)
  area <- c(areaA,areaB)
  sdb <- data.frame(ratio,area,embID)
  pvalAB <- anova.to.pval(sdb)

  # B vs C
  ratio <- c(ratioC,ratioB)
  area <- c(areaC,areaB)
  sdb <- data.frame(ratio,area,embID)
  pvalBC <- anova.to.pval(sdb)
  
  # A vs C
  ratio <- c(ratioA,ratioC)
  area <- c(areaA,areaC)
  sdb <- data.frame(ratio,area,embID)
  pvalAC <- anova.to.pval(sdb)
  
  ratio.anova <- rbind(ratio.anova, c(pvalAB,pvalBC,pvalAC))
}

#ratio.anova <- data.frame(ratio.anova)
#colnames(ratio.anova) <- c("age","AvB","BvC","AvC")
#row.names(ratio.anova) <- ratio.anova$age
#ratio.anova$age <- NULL
```

Pvalues are not corrected for multiple testing yet. We will use the Holm procedure to do so.

```{r}
# combine all rows into one vector
ratio.anova.vector <- c(ratio.anova[,1],ratio.anova[,2],ratio.anova[,3])

# run Holms
rav.adj <- p.adjust(ratio.anova.vector,method="holm")

# put back into table
ratio.anova.adj <- cbind(rav.adj[1:6],rav.adj[7:12],rav.adj[13:18])
```




Make a heatmap with the data, to visualize p values more easily.

```{r}
#ratio.adj <- ratio.anova[,grep('v',names(ratio.anova),value=TRUE)]

library(gplots)
breaks = c(0,0.001,0.01,0.05,0.1,1)
col = c("darkred","red","orange","gold","khaki")
heatmap.2(t(ratio.anova.adj), breaks=breaks, col=col,dendrogram='none',trace='none',Rowv=F,Colv=F,key=F)

```




```{r import and modify old data}
ccdb.old <- read.csv("/Users/BarbaraMaria/Dropbox/projects/2014_Ofas-measurements/cell_count_sample/cellcounts.csv", header=T)
# separate info for area 1, 2, 3
ccdb.old.1 <- ccdb.old[ccdb.old$area == "area_1",]
ccdb.old.2 <- ccdb.old[ccdb.old$area == "area_2",]
ccdb.old.3 <- ccdb.old[ccdb.old$area == "area_3",]
#area 1 = A; 2=B; 3=C. Ensure column names are correct:
colnames(ccdb.old.1) <- c("embryoID","area","areaA_DAPI","areaA_PH3","areaA")
colnames(ccdb.old.2) <- c("embryoID","area","areaB_DAPI","areaB_PH3","areaB")
colnames(ccdb.old.3) <- c("embryoID","area","areaC_DAPI","areaC_PH3","areaC")
#remove "area" column:
ccdb.old.1$area <- NULL
ccdb.old.2$area <- NULL
ccdb.old.3$area <- NULL
#merge the three databases
ccdb.old.adj <- merge(ccdb.old.1,ccdb.old.2, by="embryoID")
ccdb.old.adj <- merge(ccdb.old.adj,ccdb.old.3, by="embryoID")

#add an "age" column
ccdb.old.adj$age <- rep("unknown",dim(ccdb.old.adj)[1])
#ccdb.old.adj$numerical_age <- rep("unknown",dim(ccdb.old.adj)[1])

#remove columns that are not used in the database now constructed
superfluouscols <- colnames(ccdb)[!colnames(ccdb)%in%colnames(ccdb.old.adj)]
ccdb.removecols <- ccdb
ccdb.removecols[superfluouscols] <- NULL

#combine both databases
ccdb.combined <- rbind(ccdb.removecols,ccdb.old.adj)
```


```{r statistics on combined data}
nemb = dim(ccdb.combined)[1]

# a vs b
ratio = c(ccdb.combined$areaA,ccdb.combined$areaB)
area = c(rep("a",nemb),rep("b",nemb))
embID = c(ccdb.combined$embryoID,ccdb.combined$embryoID)
sdb <- data.frame(ratio,area,embID)
pvalAB <- anova.to.pval(sdb)

# a vs c
ratio = c(ccdb.combined$areaA,ccdb.combined$areaC)
area = c(rep("a",nemb),rep("c",nemb))
sdb <- data.frame(ratio,area,embID)
pvalAC <- anova.to.pval(sdb)

# b vs c
ratio = c(ccdb.combined$areaB,ccdb.combined$areaC)
area = c(rep("b",nemb),rep("c",nemb))
sdb <- data.frame(ratio,area,embID)
pvalBC <- anova.to.pval(sdb)

#RESULTS:
#Posterior vs. anterior growth zone
pvalAB
#Anterior growth zone vs. germ band
pvalBC
#Posterior growth zone vs. germ band
pvalAC

#adjust pvalues for multiple testing with holm procedure
AB_BC_AC.adj <- p.adjust(c(pvalAB,pvalBC,pvalAC),method="holm")
AB_BC_AC.adj
```

Make a boxplot of all the data combined (i.e. not split up over time points).

```{r boxplot all data}
#svg("/Users/BarbaraMaria/Dropbox/projects/2014_Ofas-measurements/mitosis_total.svg",width=10,height=7)
boxplot(ccdb.combined$areaA,ccdb.combined$areaB,ccdb.combined$areaC, col=c("darkblue","darkgreen","indianred"),ylab="proportion of cells in mitosis",names=c("posterior gz","anterior gz","germband"))
#dev.off()
```

```{r save database}
colnames(ccdb.combined) <- c("embryoID","age","posteriorGZ_DAPI","posteriorGZ_PH3","anteriorGZ_DAPI","anteriorGZ_PH3","germband_DAPI","germband_PH3","posteriorGZ_ratio","anteriorGZ_ratio","germband_ratio")

write.table(ccdb.combined,file="/Users/BarbaraMaria/Dropbox/projects/2014_Ofas-measurements/ccdbcombined.csv",row.names=FALSE,sep=",")

```

